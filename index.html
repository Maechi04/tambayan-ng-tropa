<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tambayan ng Tropa - Profile</title>
<link rel="stylesheet" href="style.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
body,html{height:100%; overflow-x:hidden;}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:#0038A8;color:white;position:relative;}
header h1{font-size:24px;}
#topCenter {position:absolute; left:50%; transform:translateX(-50%); text-align:center;}
#topCenter p {margin:2px;}
main{padding:20px; display:flex; flex-direction:column; align-items:center; min-height:80vh;}
.profile-card {border:1px solid #ccc; padding:10px; margin-bottom:20px; width:90%; max-width:600px; border-radius:10px; background:rgba(255,255,255,0.9);}
.profile-card img {max-width:100px; border-radius:50%;}
.section-title {font-size:20px; margin:10px 0;}
.friends-list, .messages {margin-top:10px;}
.friend-item, .message-item {padding:5px; border-bottom:1px solid #ccc;}
.friend-item button {margin-left:10px; padding:2px 6px; cursor:pointer;}
footer{background:#0038A8;color:white;padding:20px;text-align:center;margin-top:20px;}
</style>
</head>
<body>

<header>
  <h1>Tambayan ng Tropa</h1>
  <div id="topCenter">
    <p id="dateTime">Loading date & time...</p>
    <p id="eventTimer">Loading events...</p>
    <p id="weather">Loading weather...</p>
    <p id="traffic">Loading traffic advisory...</p>
  </div>
  <button id="logoutBtn" style="background:#FF0000;color:white;padding:8px 16px;border:none;border-radius:5px;cursor:pointer;">Logout</button>
</header>

<main>
  <div class="profile-card">
    <h2 id="displayName">User Name</h2>
    <img id="profilePicDisplay" src="" alt="Profile Picture">
    <img id="backgroundPicDisplay" src="" alt="Background Picture" style="width:100%; margin-top:10px; border-radius:10px;">
    <audio id="backgroundMusic" controls style="width:100%; margin-top:10px;"></audio>

    <div class="section-title">Friends</div>
    <div class="friends-list" id="friendsList"></div>

    <div class="section-title">Post on Wall</div>
    <textarea id="postText" placeholder="Write something..." style="width:100%;padding:8px;"></textarea>
    <button id="postBtn" style="margin-top:5px;background:#0038A8;color:white;padding:8px;border:none;border-radius:5px;cursor:pointer;">Post</button>

    <div class="section-title">Messages / Wall</div>
    <div class="messages" id="messagesList"></div>
  </div>
</main>

<footer>
  <p>Tambayan ng Tropa &copy; 2025</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import { getStorage, ref, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAnJGJRlBw1spQ-1dY5L1miVyQ5ptnoNV4",
  authDomain: "tambayanngtropa-86436.firebaseapp.com",
  projectId: "tambayanngtropa-86436",
  storageBucket: "tambayanngtropa-86436.appspot.com",
  messagingSenderId: "1056515077642",
  appId: "1:1056515077642:web:6e4638e28f93dda68b11f3",
  measurementId: "G-R093DGT56H"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUserId = null;

// ----------------- Auth State -----------------
onAuthStateChanged(auth, async (user) => {
  if(!user){ alert("Please login!"); window.location.href="index.html"; return;}
  currentUserId = user.uid;
  loadProfile();
});

// ----------------- Logout -----------------
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  await signOut(auth);
  window.location.href="index.html";
});

// ----------------- Load Profile -----------------
async function loadProfile(){
  const userDoc = await getDoc(doc(db,"users",currentUserId));
  const data = userDoc.data();
  document.getElementById("displayName").textContent = data.displayName;

  if(data.profilePic){
    const url = await getDownloadURL(ref(storage, `${currentUserId}/profilePic`));
    document.getElementById("profilePicDisplay").src = url;
  }
  if(data.backgroundPic){
    const url = await getDownloadURL(ref(storage, `${currentUserId}/backgroundPic`));
    document.getElementById("backgroundPicDisplay").src = url;
  }
  if(data.musicUrl){
    const url = await getDownloadURL(ref(storage, `${currentUserId}/musicUrl`));
    document.getElementById("backgroundMusic").src = url;
  }

  loadFriends(data.friends || []);
  loadMessages();
}

// ----------------- Friends -----------------
async function loadFriends(friendIds){
  const friendsDiv = document.getElementById("friendsList");
  friendsDiv.innerHTML="";
  for(let fid of friendIds){
    const fDoc = await getDoc(doc(db,"users",fid));
    const fData = fDoc.data();
    const div = document.createElement("div");
    div.classList.add("friend-item");
    div.textContent = fData.displayName + " (" + (fData.nickname||"") + ")";
    const addBtn = document.createElement("button");
    addBtn.textContent="Message";
    addBtn.onclick=()=>{ let msg = prompt("Write message to "+fData.displayName); if(msg) sendMessage(fid,msg);}
    div.appendChild(addBtn);
    friendsDiv.appendChild(div);
  }
}

// ----------------- Post on Wall -----------------
document.getElementById("postBtn").addEventListener("click", async ()=>{
  const text = document.getElementById("postText").value;
  if(!text) return alert("Please enter text!");
  const postRef = doc(collection(db,"messages"));
  await setDoc(postRef,{from:currentUserId,to:currentUserId,text});
  document.getElementById("postText").value="";
  loadMessages();
});

async function loadMessages(){
  const messagesDiv = document.getElementById("messagesList");
  messagesDiv.innerHTML="";
  const snap = await getDocs(collection(db,"messages"));
  snap.forEach(docSnap=>{
    const msg = docSnap.data();
    if(msg.to===currentUserId){
      const div = document.createElement("div");
      div.classList.add("message-item");
      div.textContent = `From ${msg.from}: ${msg.text}`;
      messagesDiv.appendChild(div);
    }
  });
}

async function sendMessage(toId, text){
  await setDoc(doc(collection(db,"messages")), {from:currentUserId,to:toId,text});
  alert("Message sent!");
}

// ----------------- Time & Date -----------------
function updateDateTime(){
  const now = new Date();
  document.getElementById("dateTime").textContent = now.toLocaleString();
}
setInterval(updateDateTime,1000);
updateDateTime();

// ----------------- Sample Event Timer -----------------
function updateEventTimer(){
  const eventDate = new Date("2025-12-31T23:59:59");
  const now = new Date();
  const diff = eventDate-now;
  if(diff>0){
    const days=Math.floor(diff/1000/60/60/24);
    const hours=Math.floor(diff/1000/60/60)%24;
    const mins=Math.floor(diff/1000/60)%60;
    const secs=Math.floor(diff/1000)%60;
    document.getElementById("eventTimer").textContent = `Next Event: New Year in ${days}d ${hours}h ${mins}m ${secs}s`;
  }else{
    document.getElementById("eventTimer").textContent="No upcoming events";
  }
}
setInterval(updateEventTimer,1000);
updateEventTimer();

// ----------------- Weather & Traffic -----------------
async function updateWeatherAndTraffic(){
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;
    const apiKey = "YOUR_OPENWEATHERMAP_API_KEY"; // replace with your key
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`);
    const weatherData = await res.json();
    document.getElementById("weather").textContent = `Weather: ${weatherData.weather[0].description}, ${weatherData.main.temp}Â°C`;
    document.getElementById("traffic").textContent = `Traffic advisory: Roads in your area are clear`; 
  });
}
updateWeatherAndTraffic();
</script>
</body>
</html>
